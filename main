# -*- coding: utf-8 -*-
import logging
import random
from datetime import datetime, timedelta
from functools import wraps

from telegram import Update, ChatPermissions
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    ContextTypes,
)

# ---------- –ù–ê–°–¢–†–û–ô–ö–ò ----------
BOT_TOKEN = "8508729401:AAFQ3QXGwFEyGZzaRz1h9PUnNZypHTmkztA"          # –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
WARN_LIMIT = 3                         # –ª–∏–º–∏—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –¥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—É—Ç–∞
MUTE_DURATION = 86400                   # –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞ (—Å–µ–∫)
ADMIN_IDS = None                        # —Å–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–æ–≤ (–∏–ª–∏ None –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–∏ –≤ —á–∞—Ç–µ)

# ---------- –õ–û–ì–ò–†–û–í–ê–ù–ò–ï ----------
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# ---------- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ----------
async def is_admin(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id: int = None) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —á–∞—Ç–∞."""
    if user_id is None:
        user_id = update.effective_user.id

    if ADMIN_IDS is not None:
        return user_id in ADMIN_IDS

    chat_id = update.effective_chat.id
    try:
        member = await context.bot.get_chat_member(chat_id, user_id)
        return member.status in ("administrator", "creator")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤: {e}")
        return False

def admin_only(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–æ–º–∞–Ω–¥–µ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE):
        if not await is_admin(update, context):
            await update.message.reply_text("‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.")
            return
        return await func(update, context)
    return wrapper

def get_warns_key(chat_id, user_id):
    return f"warns_{chat_id}_{user_id}"

# ---------- –ê–î–ú–ò–ù-–ö–û–ú–ê–ù–î–´ ----------
@admin_only
async def mute(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–º—É—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç–≤–µ—Ç–æ–º). /mute [–º–∏–Ω—É—Ç—ã]"""
    if not update.message.reply_to_message:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–º—É—Ç–∏—Ç—å.")
        return

    user_id = update.message.reply_to_message.from_user.id
    chat_id = update.effective_chat.id

    duration_minutes = 10
    if context.args:
        try:
            duration_minutes = int(context.args[0])
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏. –ü—Ä–∏–º–µ—Ä: /mute 30")
            return

    until_date = datetime.now() + timedelta(minutes=duration_minutes)
    permissions = ChatPermissions(can_send_messages=False)

    try:
        await context.bot.restrict_chat_member(chat_id, user_id, permissions, until_date=until_date)
        await update.message.reply_text(f"üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –º—É—Ç –Ω–∞ {duration_minutes} –º–∏–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –º—É—Ç–∞: {e}")
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º—É—Ç–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞.")

@admin_only
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç–≤–µ—Ç–æ–º). /ban"""
    if not update.message.reply_to_message:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–∞–Ω–∏—Ç—å.")
        return

    user_id = update.message.reply_to_message.from_user.id
    chat_id = update.effective_chat.id

    try:
        await context.bot.ban_chat_member(chat_id, user_id)
        await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –±–∞–Ω–∞: {e}")
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–±–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –±–æ—Ç–∞.")

@admin_only
async def warn(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (–æ—Ç–≤–µ—Ç–æ–º). /warn"""
    if not update.message.reply_to_message:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–º—É —Ö–æ—Ç–∏—Ç–µ –≤—ã–¥–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.")
        return

    user_id = update.message.reply_to_message.from_user.id
    chat_id = update.effective_chat.id
    key = get_warns_key(chat_id, user_id)

    warns = context.bot_data.get(key, 0) + 1
    context.bot_data[key] = warns

    await update.message.reply_text(f"‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ {warns}/{WARN_LIMIT}.")

    if warns >= WARN_LIMIT:
        until_date = datetime.now() + timedelta(seconds=MUTE_DURATION)
        permissions = ChatPermissions(can_send_messages=False)
        try:
            await context.bot.restrict_chat_member(chat_id, user_id, permissions, until_date=until_date)
            await update.message.reply_text(f"üîá –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª {WARN_LIMIT} –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –∑–∞–º—É—á–µ–Ω –Ω–∞ {MUTE_DURATION//3600} —á.")
            context.bot_data.pop(key, None)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º—É—Ç–∞: {e}")
            await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º—É—Ç–∏—Ç—å, –Ω–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞—Å—á–∏—Ç–∞–Ω–æ.")

@admin_only
async def unmute(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–Ω—è—Ç—å –º—É—Ç (–æ—Ç–≤–µ—Ç–æ–º). /unmute"""
    if not update.message.reply_to_message:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —Å–Ω—è—Ç—å –º—É—Ç.")
        return

    user_id = update.message.reply_to_message.from_user.id
    chat_id = update.effective_chat.id

    permissions = ChatPermissions(
        can_send_messages=True,
        can_send_media_messages=True,
        can_send_polls=True,
        can_send_other_messages=True,
        can_add_web_page_previews=True,
        can_change_info=True,
        can_invite_users=True,
        can_pin_messages=True,
    )

    try:
        await context.bot.restrict_chat_member(chat_id, user_id, permissions)
        await update.message.reply_text("üîä –ú—É—Ç —Å–Ω—è—Ç.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è –º—É—Ç–∞: {e}")
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–Ω—è—Ç—å –º—É—Ç.")

@admin_only
async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞–∑–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ—Ç–≤–µ—Ç–æ–º). /unban"""
    if not update.message.reply_to_message:
        await update.message.reply_text("‚ö†Ô∏è –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–±–∞–Ω–∏—Ç—å.")
        return

    user_id = update.message.reply_to_message.from_user.id
    chat_id = update.effective_chat.id

    try:
        await context.bot.unban_chat_member(chat_id, user_id, only_if_banned=True)
        await update.message.reply_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ä–∞–∑–±–∞–Ω–∞: {e}")
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–∞–Ω–∏—Ç—å.")

@admin_only
async def add_word(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–î–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–æ –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫. /add —Å–ª–æ–≤–æ"""
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.\n–ü—Ä–∏–º–µ—Ä: /add —Å–ø–∞–º")
        return

    word = " ".join(context.args).lower().strip()
    bad_words = context.bot_data.setdefault("bad_words", set())

    if word in bad_words:
        await update.message.reply_text(f"–°–ª–æ–≤–æ ¬´{word}¬ª —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ.")
    else:
        bad_words.add(word)
        await update.message.reply_text(f"–°–ª–æ–≤–æ ¬´{word}¬ª –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö.")

@admin_only
async def remove_word(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–≤–æ –∏–∑ —á—ë—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞. /del —Å–ª–æ–≤–æ"""
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.\n–ü—Ä–∏–º–µ—Ä: /del —Å–ø–∞–º")
        return

    word = " ".join(context.args).lower().strip()
    bad_words = context.bot_data.get("bad_words", set())

    if word in bad_words:
        bad_words.remove(word)
        await update.message.reply_text(f"–°–ª–æ–≤–æ ¬´{word}¬ª —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Å–ø–∏—Å–∫–∞.")
    else:
        await update.message.reply_text(f"–°–ª–æ–≤–æ ¬´{word}¬ª –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Å–ø–∏—Å–∫–µ.")

@admin_only
async def list_words(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤. /list"""
    bad_words = context.bot_data.get("bad_words", set())
    if not bad_words:
        await update.message.reply_text("–°–ø–∏—Å–æ–∫ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤ –ø—É—Å—Ç.")
        return

    words_list = "\n".join(sorted(bad_words))
    await update.message.reply_text(f"üìã –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞:\n{words_list}")

# ---------- –ê–í–¢–û–£–î–ê–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ----------
async def auto_delete(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞."""
    if not update.message or not update.message.text:
        return
    if update.message.text.startswith("/"):
        return

    text = update.message.text.lower()
    bad_words = context.bot_data.get("bad_words", set())
    if not bad_words:
        return

    for word in bad_words:
        if word in text:
            try:
                await update.message.delete()
                logger.info(f"–£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {update.effective_user.id} (—Å–ª–æ–≤–æ: {word})")
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
            break

# ---------- –ò–ì–†–´ ----------
async def rps(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ò–≥—Ä–∞ –∫–∞–º–µ–Ω—å-–Ω–æ–∂–Ω–∏—Ü—ã-–±—É–º–∞–≥–∞. /knb –∫–∞–º–µ–Ω—å/–Ω–æ–∂–Ω–∏—Ü—ã/–±—É–º–∞–≥–∞"""
    if not context.args:
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ: –∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã –∏–ª–∏ –±—É–º–∞–≥–∞.\n–ü—Ä–∏–º–µ—Ä: /knb –∫–∞–º–µ–Ω—å")
        return

    user_choice = context.args[0].lower()
    if user_choice not in ("–∫–∞–º–µ–Ω—å", "–Ω–æ–∂–Ω–∏—Ü—ã", "–±—É–º–∞–≥–∞"):
        await update.message.reply_text("–î–æ–ø—É—Å—Ç–∏–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: –∫–∞–º–µ–Ω—å, –Ω–æ–∂–Ω–∏—Ü—ã, –±—É–º–∞–≥–∞.")
        return

    bot_choice = random.choice(["–∫–∞–º–µ–Ω—å", "–Ω–æ–∂–Ω–∏—Ü—ã", "–±—É–º–∞–≥–∞"])
    result = ""
    if user_choice == bot_choice:
        result = "–ù–∏—á—å—è! ü§ù"
    elif (user_choice == "–∫–∞–º–µ–Ω—å" and bot_choice == "–Ω–æ–∂–Ω–∏—Ü—ã") or \
         (user_choice == "–Ω–æ–∂–Ω–∏—Ü—ã" and bot_choice == "–±—É–º–∞–≥–∞") or \
         (user_choice == "–±—É–º–∞–≥–∞" and bot_choice == "–∫–∞–º–µ–Ω—å"):
        result = "–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! üéâ"
    else:
        result = "–ë–æ—Ç –≤—ã–∏–≥—Ä–∞–ª! ü§ñ"

    await update.message.reply_text(f"–í–∞—à –≤—ã–±–æ—Ä: {user_choice}\n–ë–æ—Ç –≤—ã–±—Ä–∞–ª: {bot_choice}\n{result}")

async def guess_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞—Ç—å –∏–≥—Ä—É ¬´–£–≥–∞–¥–∞–π —á–∏—Å–ª–æ¬ª. –ë–æ—Ç –∑–∞–≥–∞–¥—ã–≤–∞–µ—Ç —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10."""
    chat_id = update.effective_chat.id
    number = random.randint(1, 10)
    context.bot_data[f"guess_{chat_id}"] = number
    await update.message.reply_text("–Ø –∑–∞–≥–∞–¥–∞–ª —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–≥–∞–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /guess <—á–∏—Å–ª–æ>")

async def guess(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–ø—ã—Ç–∫–∞ —É–≥–∞–¥–∞—Ç—å —á–∏—Å–ª–æ. /guess —á–∏—Å–ª–æ"""
    if not context.args:
        await update.message.reply_text("–£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: /guess 5")
        return

    chat_id = update.effective_chat.id
    secret = context.bot_data.get(f"guess_{chat_id}")
    if secret is None:
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /guess")
        return

    try:
        user_guess = int(context.args[0])
    except ValueError:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
        return

    if user_guess == secret:
        await update.message.reply_text(f"–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –í—ã —É–≥–∞–¥–∞–ª–∏ —á–∏—Å–ª–æ {secret}! üéâ")
        # —É–¥–∞–ª—è–µ–º –∑–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ, —á—Ç–æ–±—ã –∏–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å
        del context.bot_data[f"guess_{chat_id}"]
    else:
        hint = "–±–æ–ª—å—à–µ" if user_guess < secret else "–º–µ–Ω—å—à–µ"
        await update.message.reply_text(f"–ù–µ–≤–µ—Ä–Ω–æ. –ó–∞–≥–∞–¥–∞–Ω–Ω–æ–µ —á–∏—Å–ª–æ {hint}.")

# ---------- –°–ò–°–¢–ï–ú–ê –ë–†–ê–ö–û–í ----------
async def propose(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±—Ä–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. /marry @username"""
    if not update.message.reply_to_message and not context.args:
        await update.message.reply_text("–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ @username.\n–ü—Ä–∏–º–µ—Ä: /marry @durov")
        return

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if update.message.reply_to_message:
        target_user = update.message.reply_to_message.from_user
    else:
        # –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å username –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        username = context.args[0].lstrip('@')
        try:
            # –ò—â–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ username (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏)
            # –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å get_chat_member, –Ω–æ —ç—Ç–æ —Å–ª–æ–∂–Ω–µ–µ
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –±—É–¥–µ–º —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ —á–∞—Ç–µ
            target_user = None
            async for member in context.bot.get_chat_administrators(update.effective_chat.id):
                if member.user.username and member.user.username.lower() == username.lower():
                    target_user = member.user
                    break
            if not target_user:
                # –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å —Å—Ä–µ–¥–∏ –æ–±—ã—á–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –Ω–æ API –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –ø—Ä–∞–≤.
                # –ü–æ—ç—Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–¥–∏–º –æ–±—ä–µ–∫—Ç User —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º ID? –ù–µ–ª—å–∑—è.
                await update.message.reply_text("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –≤ —á–∞—Ç–µ, –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.")
                return
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")
            await update.message.reply_text("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
            return

    proposer = update.effective_user
    chat_id = update.effective_chat.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç –ª–∏ –∫—Ç–æ-—Ç–æ —É–∂–µ –≤ –±—Ä–∞–∫–µ
    marriages = context.bot_data.setdefault("marriages", {})
    if proposer.id in marriages:
        await update.message.reply_text("–í—ã —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ. –°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≤–µ–¥–∏—Ç–µ—Å—å.")
        return
    if target_user.id in marriages:
        await update.message.reply_text("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –±—Ä–∞–∫–µ.")
        return
    if proposer.id == target_user.id:
        await update.message.reply_text("–ù–µ–ª—å–∑—è –∂–µ–Ω–∏—Ç—å—Å—è –Ω–∞ —Å–∞–º–æ–º —Å–µ–±–µ.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
    proposals = context.bot_data.setdefault("proposals", {})
    proposals[target_user.id] = proposer.id
    await update.message.reply_text(
        f"üíç {proposer.first_name} –ø—Ä–µ–¥–ª–æ–∂–∏–ª(–∞) –±—Ä–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user.first_name}.\n"
        f"–ß—Ç–æ–±—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è, {target_user.first_name}, –Ω–∞–ø–∏—à–∏—Ç–µ /agree.\n"
        f"–ß—Ç–æ–±—ã –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è, –Ω–∞–ø–∏—à–∏—Ç–µ /–æ—Ç–∫–∞–∑–∞—Ç—å—Å—è."
    )

async def accept(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–∏–Ω—è—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±—Ä–∞–∫–∞. /accept"""
    user_id = update.effective_user.id
    proposals = context.bot_data.get("proposals", {})
    if user_id not in proposals:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±—Ä–∞–∫–∞.")
        return

    proposer_id = proposals[user_id]
    marriages = context.bot_data.setdefault("marriages", {})
    if proposer_id in marriages or user_id in marriages:
        await update.message.reply_text("–ö—Ç–æ-—Ç–æ –∏–∑ –≤–∞—Å —É–∂–µ —Å–æ—Å—Ç–æ–∏—Ç –≤ –±—Ä–∞–∫–µ.")
        del proposals[user_id]
        return

    # –ó–∞–∫–ª—é—á–∞–µ–º –±—Ä–∞–∫
    marriages[proposer_id] = user_id
    marriages[user_id] = proposer_id
    del proposals[user_id]

    await update.message.reply_text("üíû –ü–æ–∑–¥—Ä–∞–≤–ª—è—é! –ë—Ä–∞–∫ –∑–∞–∫–ª—é—á—ë–Ω! üíû")

async def reject(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –±—Ä–∞–∫–∞. /deny"""
    user_id = update.effective_user.id
    proposals = context.bot_data.get("proposals", {})
    if user_id not in proposals:
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –±—Ä–∞–∫–∞.")
        return

    proposer_id = proposals[user_id]
    del proposals[user_id]
    await update.message.reply_text("‚ùå –í—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç –±—Ä–∞–∫–∞.")

async def divorce(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–†–∞–∑–≤–µ—Å—Ç–∏—Å—å. /razvod"""
    user_id = update.effective_user.id
    marriages = context.bot_data.get("marriages", {})
    if user_id not in marriages:
        await update.message.reply_text("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        return

    partner_id = marriages[user_id]
    del marriages[user_id]
    del marriages[partner_id]
    await update.message.reply_text("üíî –ë—Ä–∞–∫ —Ä–∞—Å—Ç–æ—Ä–≥–Ω—É—Ç.")

async def family(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–º—å–µ. /family"""
    user_id = update.effective_user.id
    marriages = context.bot_data.get("marriages", {})
    if user_id not in marriages:
        await update.message.reply_text("–í—ã –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç–µ –≤ –±—Ä–∞–∫–µ.")
        return

    partner_id = marriages[user_id]
    try:
        partner = await context.bot.get_chat(partner_id)
        partner_name = partner.first_name
    except:
        partner_name = "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

    await update.message.reply_text(f"üíë –í—ã –≤ –±—Ä–∞–∫–µ —Å {partner_name}.")

# ---------- –ó–ê–ü–£–°–ö ----------
def main():
    if BOT_TOKEN == "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê":
        logger.error("–¢–æ–∫–µ–Ω –Ω–µ –∑–∞–¥–∞–Ω! –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é BOT_TOKEN –≤ –∫–æ–¥–µ.")
        return

    application = Application.builder().token(BOT_TOKEN).build()

    # –•—Ä–∞–Ω–∏–ª–∏—â–∞
    application.bot_data["bad_words"] = set()
    application.bot_data["marriages"] = {}
    application.bot_data["proposals"] = {}

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ (—Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
    application.add_handler(CommandHandler("mute", mute))
    application.add_handler(CommandHandler("ban", ban))
    application.add_handler(CommandHandler("warn", warn))
    application.add_handler(CommandHandler("unmute", unmute))
    application.add_handler(CommandHandler("unban", unban))
    application.add_handler(CommandHandler("add", add_word))
    application.add_handler(CommandHandler("del", remove_word))
    application.add_handler(CommandHandler("list", list_words))

    # –ò–≥—Ä—ã
    application.add_handler(CommandHandler("knb", rps))
    application.add_handler(CommandHandler("guess", guess))
    application.add_handler(CommandHandler(["startguess", "—É–≥–∞–¥–∞–π"], guess_start))  # –¥–≤–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å—Ç–∞—Ä—Ç–∞

    # –ë—Ä–∞–∫–∏
    application.add_handler(CommandHandler("marry", propose))
    application.add_handler(CommandHandler("agree", accept))
    application.add_handler(CommandHandler("deny", reject))
    application.add_handler(CommandHandler("razvod", divorce))
    application.add_handler(CommandHandler("family", family))

    

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling()

if __name__ == "__main__":
    main()
